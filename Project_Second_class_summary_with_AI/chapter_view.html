<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter Viewer | Smart Learning AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');

        :root {
            --primary: #6366f1;
            --accent: #22d3ee;
            --bg: #0f172a;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        nav {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .pdf-container {
            height: 85vh;
            background: #1e293b;
            border-radius: 24px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
        }

        iframe {
            border: none;
            background: white;
        }

        .sticky-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .sticky-btn:hover {
            transform: scale(1.1) translateY(-5px);
        }

        .btn-ai {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }

        .ai-loader {
            display: none;
            padding: 40px;
            text-align: center;
        }

        .shimmer-text {
            background: linear-gradient(90deg, #94a3b8 0%, #ffffff 50%, #94a3b8 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 2s linear infinite;
        }

        @keyframes shimmer {
            to { background-position: 200% center; }
        }

        .gen-image {
            opacity: 0;
            filter: blur(10px);
            transform: translateY(20px);
            transition: all 0.8s ease-out;
            position: relative;
            overflow: hidden;
            border-radius: 20px;
        }

        .gen-image.ready {
            opacity: 1;
            filter: blur(0);
            transform: translateY(0);
        }

        .img-wrapper {
            width: 100%;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
            overflow: hidden;
            min-height: 180px;
        }

        .gen-image::after {
            content: '';
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent, var(--accent), transparent);
            opacity: 0.5;
            animation: scan 1.5s linear;
            pointer-events: none;
        }

        @keyframes scan {
            0% { top: -100%; }
            100% { top: 100%; }
        }

        @media (max-width: 768px) {
            .pdf-container { height: 75vh; }
            .sticky-btn { bottom: 20px; right: 20px; }
        }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <nav class="flex items-center justify-between p-4 mb-6 rounded-2xl">
        <button onclick="history.back()" class="flex items-center gap-2 text-slate-400 hover:text-white transition-all font-bold text-xs uppercase tracking-widest group">
            <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i> Back
        </button>
        <div class="text-sm font-black tracking-tighter text-slate-500">
            SMART<span class="text-indigo-500">VIEWER</span>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto w-full flex flex-col gap-6 flex-grow">
        <div class="pdf-container">
            <iframe id="pdf" width="100%" height="100%" src="about:blank"></iframe>
        </div>

        <div id="visuals-area" class="pb-24">
            <div id="loader" class="ai-loader">
                <div class="inline-block p-6 glass-card rounded-3xl bg-slate-800/50 border border-slate-700">
                    <div class="flex items-center gap-4">
                        <i class="fas fa-microchip animate-spin text-indigo-400 text-xl"></i>
                        <span class="shimmer-text font-bold">AI is scanning the document and generating summaries...</span>
                    </div>
                </div>
            </div>

            <div id="images" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Filtered AI Images appear here -->
            </div>
        </div>
    </div>

    <div class="sticky-btn">
        <button onclick="summarize()" class="btn-ai px-8 py-5 rounded-2xl flex items-center gap-3 text-white font-bold group">
            <i class="fas fa-wand-magic-sparkles"></i>
            <span>Summarize with AI</span>
        </button>
    </div>

    <script>
        const params = new URLSearchParams(location.search);
        const pdfFile = params.get("pdf") || ""; // Expected: "1_eng1.pdf", "2_math3.pdf", etc.
        
        if(pdfFile) {
            document.getElementById("pdf").src = "pdfs/" + pdfFile;
        }

        function summarize() {
            const loader = document.getElementById("loader");
            const imgBox = document.getElementById("images");
            
            imgBox.innerHTML = "";
            loader.style.display = "block";
            
            window.scrollTo({
                top: document.getElementById('visuals-area').offsetTop - 100,
                behavior: 'smooth'
            });

            // Dataset mapping to: [Class][SubjectKey][Chapter][Image#]
            const allVisualData = [
                // Class 1 English Chapter 1
                { src: 'images/1e11.png', delay: 4500, label: 'Vocabulary Scan' },
                { src: 'images/1e12.png', delay: 6800, label: 'Language Pattern' },
                { src: 'images/1e13.png', delay: 8500, label: 'Contextual Map' },

                // Class 1 Maths Chapter 1
                { src: 'images/1m11.png', delay: 4500, label: 'Vocabulary Scan' },
                { src: 'images/1m12.png', delay: 6800, label: 'Language Pattern' },

                // Class 2 English Chapter 1
                { src: 'images/2e11.png', delay: 4500, label: 'Vocabulary Scan' },
                { src: 'images/2e12.png', delay: 6800, label: 'Language Pattern' },

                // Class 2 English Chapter 2
                { src: 'images/2e21.png', delay: 4500, label: 'Vocabulary Scan' },
                { src: 'images/2e22.png', delay: 6800, label: 'Language Pattern' },

                // Class 2 Maths Chapter 1
                { src: 'images/2m12.png', delay: 5500, label: 'Number Analysis' },

                // Class 2 Maths Chapter 3
                { src: 'images/2m31.png', delay: 7800, label: 'Calculation Matrix' },
                { src: 'images/2m33.png', delay: 9500, label: 'Geometric Insight' },

                // Class 2 EVS Chapter 1
                { src: 'images/2evs11.png', delay: 4500, label: 'Eco System' },
                { src: 'images/2evs12.png', delay: 7800, label: 'Natural Cycle' },
                { src: 'images/2evs13.png', delay: 10500, label: 'Bio Map' }
            ];

            /**
             * NEW LOGIC for parsing: 1_eng1.pdf
             */
            let classPart = "1";
            let subKey = "e";
            let chapPart = "1";

            if (pdfFile) {
                // Split by underscore: ["1", "eng1.pdf"]
                const mainParts = pdfFile.split('_');
                if (mainParts.length >= 2) {
                    classPart = mainParts[0]; // e.g., "1"
                    
                    const secondHalf = mainParts[1].toLowerCase(); // e.g., "eng1.pdf"
                    
                    // Identify subject shorthand
                    if (secondHalf.includes('eng')) subKey = 'e';
                    else if (secondHalf.includes('math')) subKey = 'm';
                    else if (secondHalf.includes('evs')) subKey = 'evs';

                    // Identify chapter number (digits after the subject name)
                    const chapterMatch = secondHalf.match(/\d+/);
                    if (chapterMatch) chapPart = chapterMatch[0];
                }
            }

            // Construct prefix for matching (e.g., "1e1")
            const targetPrefix = `${classPart}${subKey}${chapPart}`;
            console.log("Analyzing PDF:", pdfFile, "Target Prefix:", targetPrefix);

            const filteredData = allVisualData.filter(item => {
                const fileName = item.src.split('/').pop(); 
                return fileName.startsWith(targetPrefix);
            });

            if(filteredData.length === 0) {
                setTimeout(() => {
                    loader.style.display = "none";
                    imgBox.innerHTML = `
                        <div class="col-span-full text-center p-12 bg-slate-800/30 rounded-3xl border border-dashed border-slate-700">
                            <i class="fas fa-search text-slate-600 text-4xl mb-4"></i>
                            <p class="text-slate-400 italic">No specific AI visuals found for this chapter.</p>
                            <p class="text-[10px] text-slate-600 mt-2 uppercase tracking-widest font-bold">Trace ID: ${targetPrefix}</p>
                        </div>`;
                }, 1000);
                return;
            }

            filteredData.forEach((item, index) => {
                setTimeout(() => {
                    if(index === 0) loader.style.display = "none";

                    const card = document.createElement("div");
                    card.className = "gen-image bg-slate-800/50 p-4 border border-slate-700 h-full flex flex-col";
                    card.innerHTML = `
                        <div class="img-wrapper flex-grow">
                            <img src="${item.src}" 
                                 class="w-full h-auto max-h-64 object-contain rounded-lg" 
                                 onerror="this.src='https://via.placeholder.com/400x300/1e293b/6366f1?text=${targetPrefix}+Visual'">
                        </div>
                        <div class="flex items-center justify-between mt-auto pt-2">
                            <span class="text-[10px] font-black tracking-widest text-slate-500 uppercase">${item.label || 'AI Analysis'}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] text-slate-600 font-mono">${item.src.split('/').pop()}</span>
                                <i class="fas fa-check-circle text-emerald-500 text-xs"></i>
                            </div>
                        </div>
                    `;
                    imgBox.appendChild(card);
                    setTimeout(() => card.classList.add('ready'), 50);
                }, item.delay);
            });
        }
    </script>
</body>
</html>